<!DOCTYPE html>
<html>

<head>
     <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orders History</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
    crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      .active {
    background-color: gray;
  }

 body{
      background-color: #e0e9e8;
    }
        table {
      border-collapse: collapse;
      margin-top: 100px;
      font-family: Arial, sans-serif;
      font-size: 15px;
      width: 100%;
      margin-left: 150px;
      margin-bottom: 100px;
      border-radius: 10px;
      justify-content: center;
      margin-left: 5px;
      position: relative;
    }

    th,
    td {
      border: none;
      padding: 8px;
      text-align: center;
    }


    th {
      background-color: rgb(219, 219, 219);
      color: rgb(0, 0, 0);
    }
        {
            display: flex;
            flex-direction: column;
            margin: 2px;
        }

        .main {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: rgb(39, 35, 42);
            margin-top: 50px;
            height: 40px;
        }

        .main a {
            font-size: 15px;
            font-weight: bolder;
            color: white;
        }

             /* Nav Bar CSS */
    #topnav {
      width: 100%;

      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;

      background-color: Black;

      font-family: Arial, sans-serif;
      font-size: 15px;
    }

    .nav-link {
      display: inline;
      width: 100px;
      height: 55px;

      color: White;

      text-align: center;
      line-height: 55px;

      text-decoration: none;
    }

    #logo {
      width: 120px;

      background-color: rgb(198, 181, 181);

      font-weight: bold;
    }

    #about {
      position: absolute;
      top: 0;
      right: 0;
    }
         body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      
    }
    </style>
</head>

<body>
    <nav id="topnav">
        <a id="logo" class="nav-link" href="#">ShopBuzz</a>
        <a class="nav-link" href="/products">Home</a>
        
        <a class="nav-link" href="/orders">View Orders</a>

        {{#if loggedIn}}
        <a id="about" class="nav-link" href="/logout">Logout</a>
        {{else}}
        <a id="about" class="nav-link" href="/login">Logout</a>
        {{/if}}
    </nav>
    <h1>Previous Orders</h1>
    {{#if orders.length}}
    <table>
        <thead >
            <tr>
                <th>Order ID</th>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Order Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
    {{#each orders}}
    <tr>
        <td>{{this.order_id}}</td>
        <td colspan="3"></td>
        <td>{{this.total_price}}</td>
        <td id="order_status_{{this.order_id}}">{{this.order_status}}</td>
        <td>
            {{#if (eq this.order_status "Processing")}}
            <button class="btn btn-secondary" disabled>Order Done</button>
            {{else}}
            <form class="delete-form" action="/orders/{{this.order_id}}" method="post">
                <button onclick="return confirm('Are you sure you want to delete this order?')"
                    class="btn btn-danger">Delete Order</button>
            </form>
            {{/if}}
        </td>
    </tr>
    {{#each this.items}}
    <tr>
        <td></td>

        <td>{{this.product_name}}</td>
        <td>{{this.product_price}}</td>
        <td>{{this.product_quantity}}</td>
        <td>{{this.total}}</td>
    </tr>
    {{/each}}
    {{/each}}
</tbody>

    </table>

    {{else}}
    <p>You haven't placed any orders yet.</p>
    {{/if}}


    <script>
   $(document).ready(function() {
  // Set the initial order status and disable the delete button if order is processing
  $('td[id^="order_status_"]').each(function() {
    if ($(this).text() === "Processing") {
      $(this).closest("tr").find("button").prop("disabled", true);
    }
  });

  // Check if the order status has not been updated in the current session
  if (!sessionStorage.getItem("orderStatusUpdated")) {
    // Update the order status and disable the delete button after 10 seconds
    setTimeout(function() {
      $('td[id^="order_status_"]').each(function() {
        if ($(this).text() === "Ordered") {
          $(this).text("Processing");
          $(this).closest("tr").find("button").prop("disabled", true);
        }
      });
      // Set the flag to indicate that the order status has been updated
      sessionStorage.setItem("orderStatusUpdated", true);
    }, 10000);
  }

  // Reload the page after 10 seconds
  setTimeout(function() {
    location.reload();
  }, 10000);
});

if (window.location.pathname === "/orders") {
  // Get the current time in milliseconds
  const currentTime = new Date().getTime();

  // Get the page load time from sessionStorage
  const pageLoadTime = sessionStorage.getItem("pageLoadTime");

  // Calculate the time elapsed since the page was loaded
  const timeElapsed = currentTime - pageLoadTime;

  // Check if the page has not already been reloaded
  if (!sessionStorage.getItem("reloaded")) {
    // Wait for 10 seconds if the page has not already been reloaded
    if (timeElapsed < 10000) {
      setTimeout(function() {
        // Reload the current page
        sessionStorage.setItem("reloaded", true);
        location.reload();
      }, 10000 - timeElapsed);
    } else {
      // Update the order status and disable the delete button after 10 seconds
      $('td[id^="order_status_"]').each(function() {
        if ($(this).text() === "Ordered") {
          $(this).text("Processing");
          $(this).closest("tr").find("button").prop("disabled", true);
        }
      });
      // Set the flag to indicate that the page has been reloaded
      sessionStorage.setItem("reloaded", true);
    }
  }

  // Set the page load time in sessionStorage
  sessionStorage.setItem("pageLoadTime", currentTime);
}




</script>

</body>

</html>